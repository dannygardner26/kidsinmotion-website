<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Child Detection Test - Kids in Motion</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #2f506a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #1a3b4f;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Child Detection Debug Tool</h1>
        <p>This tool helps diagnose issues with parent-child account relationships in the Kids in Motion system.</p>

        <div class="user-info">
            <h3>Current User Information</h3>
            <div id="currentUser">Not logged in</div>
            <button onclick="checkAuth()">Check Authentication</button>
            <button onclick="login()">Login</button>
            <button onclick="logout()">Logout</button>
        </div>

        <div class="section info">
            <h3>Test 1: Firestore Children Query</h3>
            <p>This tests the direct Firestore query that should return your children.</p>
            <button onclick="testFirestoreQuery()">Test Firestore Query</button>
            <div id="firestoreResult"></div>
        </div>

        <div class="section info">
            <h3>Test 2: API Children Endpoint</h3>
            <p>This tests the API endpoint (which currently returns empty).</p>
            <button onclick="testAPIEndpoint()">Test API Endpoint</button>
            <div id="apiResult"></div>
        </div>

        <div class="section info">
            <h3>Test 3: Event Registration Form</h3>
            <p>This tests the same logic used in event registration.</p>
            <button onclick="testEventRegistration()">Test Event Registration Logic</button>
            <div id="eventRegResult"></div>
        </div>

        <div class="section info">
            <h3>Test 4: Add Test Child</h3>
            <p>This creates a test child to verify the creation process works.</p>
            <button onclick="addTestChild()">Add Test Child</button>
            <div id="addChildResult"></div>
        </div>

        <div class="section info">
            <h3>Test 5: Raw Firestore Data</h3>
            <p>This shows all children in Firestore for debugging.</p>
            <button onclick="getAllChildren()">Get All Children (Debug)</button>
            <div id="allChildrenResult"></div>
        </div>
    </div>

    <!-- Firebase Config -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, addDoc, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFe7YIJX_0VtKYDYA7GVTMoJDeTTAufeg",
            authDomain: "kids-in-motion-website-b1c09.firebaseapp.com",
            projectId: "kids-in-motion-website-b1c09",
            storageBucket: "kids-in-motion-website-b1c09.appspot.com",
            messagingSenderId: "839796180413",
            appId: "1:839796180413:web:b7a1f41253db31e8627ed4",
            measurementId: "G-63BGEP6TCX"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUserDisplay();
        });

        function updateUserDisplay() {
            const userDiv = document.getElementById('currentUser');
            if (currentUser) {
                userDiv.innerHTML = `
                    <strong>Logged in as:</strong><br>
                    Email: ${currentUser.email}<br>
                    UID: ${currentUser.uid}<br>
                    Verified: ${currentUser.emailVerified}
                `;
                userDiv.className = 'success';
            } else {
                userDiv.innerHTML = 'Not logged in';
                userDiv.className = 'error';
            }
        }

        // Make functions global
        window.checkAuth = function() {
            updateUserDisplay();
        };

        window.login = async function() {
            const email = prompt('Enter email:') || 'parent@gmail.com';
            const password = prompt('Enter password:') || 'parent';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                updateResult('currentUser', 'Logged in successfully', 'success');
            } catch (error) {
                updateResult('currentUser', 'Login failed: ' + error.message, 'error');
            }
        };

        window.logout = async function() {
            try {
                await signOut(auth);
                updateResult('currentUser', 'Logged out successfully', 'success');
            } catch (error) {
                updateResult('currentUser', 'Logout failed: ' + error.message, 'error');
            }
        };

        window.testFirestoreQuery = async function() {
            if (!currentUser) {
                updateResult('firestoreResult', 'Please log in first', 'error');
                return;
            }

            try {
                updateResult('firestoreResult', 'Querying Firestore...', 'info');

                const childrenRef = collection(db, 'children');
                const q = query(
                    childrenRef,
                    where('parentFirebaseUid', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                const querySnapshot = await getDocs(q);

                const children = [];
                querySnapshot.forEach((doc) => {
                    children.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                const result = `
                    <strong>Found ${children.length} children:</strong>
                    <pre>${JSON.stringify(children, null, 2)}</pre>
                `;
                updateResult('firestoreResult', result, children.length > 0 ? 'success' : 'info');
            } catch (error) {
                updateResult('firestoreResult', 'Firestore query failed: ' + error.message, 'error');
                console.error('Firestore error:', error);
            }
        };

        window.testAPIEndpoint = async function() {
            if (!currentUser) {
                updateResult('apiResult', 'Please log in first', 'error');
                return;
            }

            try {
                updateResult('apiResult', 'Calling API endpoint...', 'info');

                const token = await currentUser.getIdToken();
                const response = await fetch('https://kidsinmotion-website-839796180413.us-east4.run.app/api/children', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const result = `
                    <strong>API Response:</strong>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                updateResult('apiResult', result, 'success');
            } catch (error) {
                updateResult('apiResult', 'API call failed: ' + error.message, 'error');
                console.error('API error:', error);
            }
        };

        window.testEventRegistration = async function() {
            if (!currentUser) {
                updateResult('eventRegResult', 'Please log in first', 'error');
                return;
            }

            try {
                updateResult('eventRegResult', 'Testing event registration logic...', 'info');

                // Test both API and Firestore fallback (mimicking apiService.getChildren)
                let children = [];
                let method = 'Unknown';

                try {
                    // Try API first
                    const token = await currentUser.getIdToken();
                    const response = await fetch('https://kidsinmotion-website-839796180413.us-east4.run.app/api/children', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        children = await response.json();
                        method = 'API';
                    } else {
                        throw new Error('API failed, trying Firestore');
                    }
                } catch (apiError) {
                    // Fallback to Firestore
                    const childrenRef = collection(db, 'children');
                    const q = query(
                        childrenRef,
                        where('parentFirebaseUid', '==', currentUser.uid),
                        orderBy('createdAt', 'desc')
                    );
                    const querySnapshot = await getDocs(q);

                    children = [];
                    querySnapshot.forEach((doc) => {
                        children.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    method = 'Firestore Fallback';
                }

                const result = `
                    <strong>Event Registration Logic Test:</strong><br>
                    Method used: ${method}<br>
                    Children found: ${children.length}<br>
                    <pre>${JSON.stringify(children, null, 2)}</pre>
                `;
                updateResult('eventRegResult', result, children.length > 0 ? 'success' : 'info');
            } catch (error) {
                updateResult('eventRegResult', 'Event registration test failed: ' + error.message, 'error');
                console.error('Event registration error:', error);
            }
        };

        window.addTestChild = async function() {
            if (!currentUser) {
                updateResult('addChildResult', 'Please log in first', 'error');
                return;
            }

            try {
                updateResult('addChildResult', 'Adding test child...', 'info');

                const testChildData = {
                    firstName: 'Test',
                    lastName: 'Child',
                    age: 8,
                    grade: '3rd Grade',
                    baseballExperience: 'Beginner',
                    medicalConcerns: '',
                    foodAllergies: '',
                    additionalInformation: 'Created by debug tool',
                    parentFirebaseUid: currentUser.uid,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const docRef = await addDoc(collection(db, 'children'), testChildData);

                const result = `
                    <strong>Test child created successfully!</strong><br>
                    Document ID: ${docRef.id}<br>
                    <pre>${JSON.stringify(testChildData, null, 2)}</pre>
                `;
                updateResult('addChildResult', result, 'success');
            } catch (error) {
                updateResult('addChildResult', 'Failed to add test child: ' + error.message, 'error');
                console.error('Add child error:', error);
            }
        };

        window.getAllChildren = async function() {
            try {
                updateResult('allChildrenResult', 'Fetching all children from Firestore...', 'info');

                const childrenRef = collection(db, 'children');
                const querySnapshot = await getDocs(childrenRef);

                const allChildren = [];
                querySnapshot.forEach((doc) => {
                    allChildren.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Group by parentFirebaseUid
                const groupedChildren = {};
                allChildren.forEach(child => {
                    const parentUid = child.parentFirebaseUid || 'NO_PARENT_UID';
                    if (!groupedChildren[parentUid]) {
                        groupedChildren[parentUid] = [];
                    }
                    groupedChildren[parentUid].push(child);
                });

                let result = `<strong>Total children in database: ${allChildren.length}</strong><br><br>`;

                for (const [parentUid, children] of Object.entries(groupedChildren)) {
                    const isCurrentUser = currentUser && parentUid === currentUser.uid;
                    result += `<div style="margin-bottom: 15px; padding: 10px; background: ${isCurrentUser ? '#e3f2fd' : '#f5f5f5'}; border-radius: 5px;">`;
                    result += `<strong>Parent UID: ${parentUid} ${isCurrentUser ? '(YOU)' : ''}</strong><br>`;
                    result += `Children: ${children.length}<br>`;
                    result += `<pre>${JSON.stringify(children, null, 2)}</pre>`;
                    result += '</div>';
                }

                updateResult('allChildrenResult', result, 'success');
            } catch (error) {
                updateResult('allChildrenResult', 'Failed to get all children: ' + error.message, 'error');
                console.error('Get all children error:', error);
            }
        };

        function updateResult(elementId, content, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = type || 'info';
        }

        // Initial auth check
        updateUserDisplay();
    </script>
</body>
</html>